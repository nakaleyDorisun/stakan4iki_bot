import dotenv from "dotenv";
import { Bot, MemorySessionStorage, session, Keyboard } from "grammy";
import { MyContext, SessionData } from "./types";
import { handlerHearExport } from "./functions/handlers/hears/_handlerHearExport";
import { handlerCallBackQuery } from "./functions/handlers/callbackQuery/_buttonExportCQ";
import { startCommand } from "./functions/handlers/commands/startCommand";
import { createInlineMenu } from "./functions/createFunctions/createInlineMenu";

dotenv.config();
const botToken = process.env.BOT_TOKEN;

if (!botToken) {
  console.error(
    "–û—à–∏–±–∫–∞: BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è. –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω."
  );
  process.exit(1);
}

export const bot = new Bot<MyContext>(botToken as string);

bot.use(
  session({
    initial: (): SessionData => ({
      menuHistory: [],
      keyboardHistory: [],
      cart: [],
      orders: [],
      phone: null,
      adress: null,
      totalRub: 0,
      isWaitingForAdress: false,
      isWaitingForPhone: false,
      isWaitingForAdressChange: false,
      isWaitingForPhoneChange: false,
      isAdmin: false,
    }),
    storage: new MemorySessionStorage(),
  })
);

// –∑–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ç–æ—Ä–æ–µ –∏–º–µ–µ—Ç –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∞–≥–∞–∑–∏–Ω", "menu"
bot.command("start", startCommand);

//–°–ª—É—à–∞—Ç–µ–ª–∏ Reply –∫–Ω–æ–ø–æ–∫
bot.hears("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—éüè°", handlerHearExport.handlerMainMenu);

bot.hears("–ö–∞—Ç–∞–ª–æ–≥üìï", handlerHearExport.handlerCatalog);

bot.hears(/–ö–æ—Ä–∑–∏–Ω–∞(\((\d+)\)|\s*)/, handlerHearExport.handlerCart);

bot.hears("–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Çüîê", handlerHearExport.handlerAccoutn);

bot.hears("–ê–¥—Ä–µ—Åüè†", handlerHearExport.handlerAdress);

bot.hears("–ò–∑–º–µ–Ω–∏—Ç—å –∞–¥—Ä–µ—Å‚öôÔ∏è", handlerHearExport.handlerChangeAdress);

bot.hears("–¢–µ–ª–µ—Ñ–æ–Ω‚òéÔ∏è", handlerHearExport.handlerPhone);

bot.hears("–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω‚öôÔ∏è", handlerHearExport.handlerChangePhone);

bot.hears("–î–æ—Å—Ç–∞–≤–∫–∞üõµ", handlerHearExport.handlerDelivery);

bot.hears("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—èüìã", handlerHearExport.handlerInfo);

bot.hears("–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∞üîê", handlerHearExport.handlerAdminPanel);

bot.hears("–ù–∞–∑–∞–¥", handlerHearExport.handlerBackButton);

// –°–ª—É—à–∞—Ç–µ–ª—å –≤–≤–æ–¥–∞/–∑–∞–º–µ–Ω—ã –∞–¥—Ä–µ—Å–∞ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
bot.on("message:text", handlerHearExport.handlerPersonalDataRegister);

// –°–ª—É—à–∞—Ç–µ–ª—å –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
bot.callbackQuery("menu", handlerCallBackQuery.buttonMenuCQ);

// –†–∞–∑–¥–µ–ª –∫–∞—Ç–∞–ª–æ–≥–∞ –≤—Å–µ —Å—Ç–∞–∫–∞–Ω—á–∏–∫–∏ —Å –∑–∞–º–µ–Ω–æ–π –º–µ–Ω—é
bot.callbackQuery("button_allCaps_click", handlerCallBackQuery.buttonAllCapsCQ);

// –†–∞–∑–¥–µ–ª –∫–∞—Ç–∞–ª–æ–≥–∞ –≤—Å–µ –∫—Ä—ã—à–∫–∏ —Å –∑–∞–º–µ–Ω–æ–π –º–µ–Ω—é
bot.callbackQuery("button_allTops_click", handlerCallBackQuery.buttonAllTopsCQ);

//–ò–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
bot.callbackQuery(
  "button_addToCart_click",
  handlerCallBackQuery.buttonAddToCartCQ
);

//–ò–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä–∑–∏–Ω—É
bot.callbackQuery("deleteItems", handlerCallBackQuery.buttonDeleteItemsCQ);

//–ò–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –∫–æ—Ä–∑–∏–Ω—É
bot.callbackQuery("confirmDelete", handlerCallBackQuery.buttonConfirmDeleteCQ);

//–ò–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É –∫–æ—Ä–∑–∏–Ω—É
bot.callbackQuery("cancelDelete", handlerCallBackQuery.buttonCancelDeleteCQ);

// –§–£–ù–ö–¶–ò–û–ù–ê–õ –ö–ù–û–ü–ö–ò –û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó + –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
bot.callbackQuery("makeOrder", handlerCallBackQuery.buttonMakeOrederCQ);

////–ò–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
bot.callbackQuery("back_to_menu", handlerCallBackQuery.buttonBackToMenuCQ);

bot.callbackQuery("button_caps02_click", handlerCallBackQuery.buttonCap02CQ);

bot.callbackQuery("button_caps03_click", handlerCallBackQuery.buttonCap03CQ);

bot.callbackQuery("button_caps04_click", handlerCallBackQuery.buttonCap04CQ);

bot.callbackQuery("button_tops02_click", handlerCallBackQuery.buttonTops02CQ);

bot.callbackQuery("button_tops03_click", handlerCallBackQuery.buttonTops03CQ);

bot.callbackQuery("button_tops04_click", handlerCallBackQuery.buttonTops04CQ);

//–î—Ä—É–≥–∏–µ –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏
bot.on("callback_query", async (ctx) => {
  const action = ctx.callbackQuery.data;
  if (
    action &&
    action !== "menu" &&
    action !== "back_to_menu" &&
    action !== "cart" &&
    action !== "makeOrder" &&
    action !== "deleteItems"
  ) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ callback_data
    ctx.session.menuHistory.push(action);
    await createInlineMenu(ctx, action);
  }
});

bot.start();

console.log("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...");

process.on("SIGINT", () => {
  console.log("–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É...");
  bot.stop();
  process.exit();
});

process.on("SIGTERM", () => {
  console.log("–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É...");
  bot.stop();
  process.exit();
});
